<h1 class="no_toc" id="deployment-redundancy">Deployment redundancy</h1>

<h2 class="no_toc text-delta" id="table-of-contents">Table of contents</h2>

<ol id="markdown-toc">
  <li><a href="#scenario" id="markdown-toc-scenario">Scenario</a></li>
  <li><a href="#policy" id="markdown-toc-policy">Policy</a></li>
  <li><a href="#another-policy" id="markdown-toc-another-policy">Another policy</a></li>
</ol>

<hr />

<h2 id="scenario">Scenario</h2>

<p>Let’s say you have a deployment (<code class="language-plaintext highlighter-rouge">mydeployment</code>), fronted by a service (<code class="language-plaintext highlighter-rouge">myservice</code>). The deployment has 3 instances, and in theory, you should be able to lose one with no traffic down.</p>

<p>Let’s test that. But only during the week, and before lunch, just in case something does break.</p>

<h2 id="policy">Policy</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">scenarios</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deployment redundancy</span>
  <span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">podAction</span><span class="pi">:</span>
      <span class="na">matches</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">mydeployment</span>
            <span class="na">namespace</span><span class="pi">:</span> <span class="s">example</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="c1"># to restrict the actions to work days, you can do</span>
        <span class="pi">-</span> <span class="na">dayTime</span><span class="pi">:</span>
            <span class="na">onlyDays</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">monday</span>
              <span class="pi">-</span> <span class="s">tuesday</span>
              <span class="pi">-</span> <span class="s">wednesday</span>
              <span class="pi">-</span> <span class="s">thursday</span>
              <span class="pi">-</span> <span class="s">friday</span>
            <span class="na">startTime</span><span class="pi">:</span>
              <span class="na">hour</span><span class="pi">:</span> <span class="m">10</span>
              <span class="na">minute</span><span class="pi">:</span> <span class="m">0</span>
              <span class="na">second</span><span class="pi">:</span> <span class="m">0</span>
            <span class="na">endTime</span><span class="pi">:</span>
              <span class="na">hour</span><span class="pi">:</span> <span class="m">12</span>
              <span class="na">minute</span><span class="pi">:</span> <span class="m">30</span>
              <span class="na">second</span><span class="pi">:</span> <span class="m">0</span>

        <span class="pi">-</span> <span class="na">randomSample</span><span class="pi">:</span>
            <span class="na">size</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">actions</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">kill</span><span class="pi">:</span>
            <span class="na">force</span><span class="pi">:</span> <span class="no">false</span>

  <span class="c1"># make sure the service responds</span>
  <span class="pi">-</span> <span class="na">probeHTTP</span><span class="pi">:</span>
      <span class="na">target</span><span class="pi">:</span>
        <span class="na">service</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">myservice</span>
          <span class="na">namespace</span><span class="pi">:</span> <span class="s">example</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">8000</span>
</code></pre></div></div>

<h2 id="another-policy">Another policy</h2>

<p>Let’s say that you have three pods in the deployment. If you’d like to be sure that your policy handles a situation when one of them was already down, you can pick a third of the running ones:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">scenarios</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deployment redundancy </span><span class="m">2</span>
  <span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">podAction</span><span class="pi">:</span>
      <span class="na">matches</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">mydeployment</span>
            <span class="na">namespace</span><span class="pi">:</span> <span class="s">example</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">property</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">state</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">Running</span>
        <span class="pi">-</span> <span class="na">randomSample</span><span class="pi">:</span>
            <span class="na">ratio</span><span class="pi">:</span> <span class="m">0.34</span>
      <span class="na">actions</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">kill</span><span class="pi">:</span>
            <span class="na">force</span><span class="pi">:</span> <span class="no">false</span>

  <span class="c1"># make sure the service responds</span>
  <span class="pi">-</span> <span class="na">probeHTTP</span><span class="pi">:</span>
      <span class="na">target</span><span class="pi">:</span>
        <span class="na">service</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">myservice</span>
          <span class="na">namespace</span><span class="pi">:</span> <span class="s">example</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">8000</span>
</code></pre></div></div>
