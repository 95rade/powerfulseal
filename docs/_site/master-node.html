<h1 class="no_toc" id="taking-vms-down">Taking VMs down</h1>

<h2 class="no_toc text-delta" id="table-of-contents">Table of contents</h2>

<ol id="markdown-toc">
  <li><a href="#scenario" id="markdown-toc-scenario">Scenario</a>    <ol>
      <li><a href="#cloud-drivers" id="markdown-toc-cloud-drivers">Cloud drivers</a></li>
    </ol>
  </li>
  <li><a href="#policy" id="markdown-toc-policy">Policy</a></li>
  <li><a href="#auto-restart" id="markdown-toc-auto-restart">Auto-restart</a></li>
</ol>

<hr />

<h2 id="scenario">Scenario</h2>

<p>Let’s say that you’d like to make sure that if one of the VMs in your cluster goes down (let’s say one that’s running master nodes), some service running on them still works well.</p>

<p>Well, PowerfulSeal can do that for you.</p>

<h3 id="cloud-drivers">Cloud drivers</h3>

<p>If you’d like to modify the state of VMs, you’re going to need to configure a cloud driver. You can learn how to do that <a href="cloud-provider-requirements">here</a>.</p>

<h2 id="policy">Policy</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Test load-balancing on master nodes</span>
  <span class="na">steps</span><span class="pi">:</span>

  <span class="c1"># take down a single master VM</span>
  <span class="pi">-</span> <span class="na">nodeAction</span><span class="pi">:</span>
      <span class="c1"># pick all master VMs</span>
      <span class="na">matches</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">property</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">name"</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">.*master.*"</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="c1"># only pick the VMs which are in UP state</span>
        <span class="pi">-</span> <span class="na">property</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">state"</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">UP"</span>
        <span class="c1"># and only pick a single VM</span>
        <span class="pi">-</span> <span class="na">randomSample</span><span class="pi">:</span>
            <span class="na">size</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">actions</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">stop</span><span class="pi">:</span>
            <span class="na">force</span><span class="pi">:</span> <span class="no">false</span>

  <span class="c1"># issue an HTTP probe to the url of the service we expect to see up</span>
  <span class="pi">-</span> <span class="na">probeHTTP</span><span class="pi">:</span>
      <span class="na">target</span><span class="pi">:</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://load-balancer.example.com"</span>
      <span class="c1"># we can allow some retries, if needed</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">3</span>
      <span class="c1"># we can also make more requests to make sure we hit all instances</span>
      <span class="na">count</span><span class="pi">:</span> <span class="m">100</span>

  <span class="c1"># restart the node which are down</span>
  <span class="pi">-</span> <span class="na">nodeAction</span><span class="pi">:</span>
      <span class="c1"># pick all master VMs</span>
      <span class="na">matches</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">property</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">name"</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">.*master.*"</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="c1"># filter down to only the VMs which are in DOWN state</span>
        <span class="pi">-</span> <span class="na">property</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">state"</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">DOWN"</span>
      <span class="na">actions</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">start</span>
</code></pre></div></div>

<h2 id="auto-restart">Auto-restart</h2>

<p>By default, VMs stopped by the Seal will be auto-restarted at the end of scenario (or if there is a failure, in the cleanup). You can disable that by setting <code class="language-plaintext highlighter-rouge">autoRestart</code> to false.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Take machines down, and don't bring them back up</span>
  <span class="na">steps</span><span class="pi">:</span>

  <span class="c1"># take down a single master VM</span>
  <span class="pi">-</span> <span class="na">nodeAction</span><span class="pi">:</span>
      <span class="c1"># pick all master VMs</span>
      <span class="na">matches</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">property</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">name"</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">.*master.*"</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">randomSample</span><span class="pi">:</span>
            <span class="na">size</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">actions</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">stop</span><span class="pi">:</span>
            <span class="na">autoRestart</span><span class="pi">:</span> <span class="no">false</span>

</code></pre></div></div>
